<table class="list issues odd-even">
  <thead>
    <tr>
      <th class="checkbox"><input type="checkbox" class="check-issue" id="checkAll"/></th>
      <th>Assigned to</th>
      <th>Issue id</th>
      <th>Project name</th>
      <th>Time</th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody class="table-content">
    <% index = 0 %>
    <% @issues.zip(@times).each do |issue, time| %>
    <% if time.abs > 1e-2 %>
    <tr class="<%= index % 2 == 0 ? 'even' : 'odd' %> issue">
      <td class="checkbox"><input type="checkbox" class="check-issue"/></td>
      <td><%= issue.assigned_to %></td>
      <td><%= issue.id %></td>
      <td><%= issue.project.name %></td>
      <td><%= time %></td>
      <td><%= 1 %></td>
    </tr>
    <% index += 1 %>
    <% end %>
    <% end %>
  </tbody>
</table>

<button type="submit" class="create-report">Create report</button>

<script>
  $( document ).ready(function() {
    $('button.create-report').click(function () {
      const tbody = document.getElementsByClassName("table-content")[0];
      const issues = Array.prototype.slice.call( tbody.children )
                          .filter(line => line.cells[0].firstChild.checked);
      const entries = issues.map(issue => {
        return {
          issue_id: issue.cells[2].textContent,
          time_amount: issue.cells[4].textContent,
          coefficient: issue.cells[5].textContent,
        };
      });
      redirectPost("<%= salary_reports_url %>", { entries: entries });
    });
    $("#checkAll").click(function(){
        $('.check-issue').not(this).prop('checked', this.checked)
                         .parents('.issue').toggleClass('context-menu-selection', this.checked);
    });
    $('.check-issue').click(function(){
      $(this).parents('.issue').toggleClass('context-menu-selection');
    });
  });
  function redirectPost(url, data) {
    var form = document.createElement('form');
    document.body.appendChild(form);
    form.method = 'post';
    form.action = url;
    for (var name in data['entries']) {
      const object = data['entries'][name];
      if(object.time_amount == 0)continue;
        for(value in object){
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'entries[][' + value + ']';
          input.value = object[value];
          form.appendChild(input);
        }
    }
    form.submit();
  }
</script>

<%= context_menu %>
